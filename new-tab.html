<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=<device-width>, initial-scale=1.0" />
  <meta http-equiv="X-UA-Compatible" content="ie=edge" />
  <title>New Tab</title>
  <link rel="icon" type="image/png" sizes="48x48" href="icon48.png">
  <!-- <script type="text/javascript" src="./newtabnotes.js"></script> -->
  <!-- <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Bitter:400,700&display=swap" /> -->
</head>

<style>
  body {
    margin: 0;
    padding: 1rem;
    background: rebeccapurple;
  }

  #new-tab-notes {
    box-sizing: border-box;
    border: 0;
    font-size: 18px;
    line-height: 1.75rem;
    margin: 0;
    min-height: 100vh;
    height: auto;
    padding: 2rem 15%;
    resize: none;
    width: 100%;
    background: #202020;
    color: #ffffff;
    border-radius: 8px;
  }
</style>

<body>
  <main>
    <textarea id="new-tab-notes" placeholder="Start writing..."></textarea>
  </main>
</body>

<script>
  var timeoutId;
  const notes = document.getElementById("notes");
  document.addEventListener("keyup", logKey);

  const browser_type = getBrowser();
  if (browser_type === "Chrome") {
    var browser_obj = chrome;
  } else {
    var browser_obj = browser;
  }

  browser_obj.tabs.onActivated.addListener(tabOpen);
  browser_obj.windows.onFocusChanged.addListener(tabOpen);

  function logKey(e) {
    clearTimeout(timeoutId);
    timeoutId = setTimeout(function () {
      saveToDB();
    }, 10);
  }

  function getBrowser() {
    if (typeof chrome !== "undefined") {
      if (typeof browser !== "undefined") {
        return "Firefox";
      } else {
        return "Chrome";
      }
    } else {
      return "Edge";
    }
  }

  function saveToDB() {
    data = {
      tab_note: document.querySelector("#notes").value
    };
    if (browser_type === "Chrome") {
      chrome.storage.sync.set(data, function () { });
    } else {
      browser_obj.storage.sync.set(data);
    }
  }

  function tabOpen(tab) {
    if (browser_type === "Chrome") {
      chrome.storage.sync.get(["tab_note"], function (result) {
        if (typeof result.tab_note !== "undefined") {
          document.querySelector("#notes").value = result.tab_note;
        }
      });
    } else {
      browser_obj.storage.sync.get(["tab_note"]).then(result => {
        if (typeof result.tab_note !== "undefined") {
          document.querySelector("#notes").value = result.tab_note;
        }
      });
    }
  }

  window.addEventListener("load", () => {
    tabOpen();
  });

</script>

</html>